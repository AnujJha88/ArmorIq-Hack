<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIRS - Drift Analysis</title>
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo">üõ°Ô∏è</span>
            <span class="brand-text">TIRS Dashboard</span>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/drift" class="nav-link active">Drift Graph</a>
            <a href="/audit" class="nav-link">Audit Log</a>
        </div>
        <div class="nav-status">
            <span class="status-indicator online"></span>
            <span>System Online</span>
        </div>
    </nav>

    <main class="drift-page">
        <header class="page-header">
            <h1>Drift Analysis</h1>
            <p>Monitor agent behavior drift over time</p>
        </header>

        <div class="controls">
            <label for="agent-select">Select Agent:</label>
            <select id="agent-select" onchange="loadDriftData()">
                {% for agent in agents %}
                <option value="{{ agent }}">{{ agent }}</option>
                {% endfor %}
            </select>
            <button class="btn" onclick="loadDriftData()">üîÑ Refresh</button>
        </div>

        <div class="chart-container">
            <canvas id="driftChart"></canvas>
        </div>

        <div class="threshold-legend">
            <h3>Threshold Levels</h3>
            <div class="legend-item">
                <span class="legend-color safe"></span>
                <span>Safe (0.0 - 0.3)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color warning"></span>
                <span>Warning (0.3 - 0.6)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color danger"></span>
                <span>Danger (0.6 - 0.8)</span>
            </div>
            <div class="legend-item">
                <span class="legend-color critical"></span>
                <span>Critical (0.8+)</span>
            </div>
        </div>
    </main>

    <script src="/static/drift_chart.js"></script>
    <script>
        let chart = null;

        async function loadDriftData() {
            const agentId = document.getElementById('agent-select').value;
            
            try {
                const response = await fetch(`/api/drift/${agentId}`);
                const data = await response.json();
                
                const labels = data.history.map(h => h.time);
                const scores = data.history.map(h => h.score);
                
                updateChart(agentId, labels, scores);
            } catch (e) {
                console.error('Failed to load drift data:', e);
            }
        }

        function updateChart(agentId, labels, scores) {
            const ctx = document.getElementById('driftChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Drift Score - ${agentId}`,
                        data: scores,
                        borderColor: '#00f5ff',
                        backgroundColor: 'rgba(0, 245, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: scores.map(s => 
                            s >= 0.8 ? '#ff0000' : 
                            s >= 0.6 ? '#ff6b6b' : 
                            s >= 0.3 ? '#ffa500' : '#00ff00'
                        ),
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#e0e0e0' }
                        }
                    },
                    scales: {
                        y: {
                            min: 0,
                            max: 1,
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e0e0e0' }
                        },
                        x: {
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            ticks: { color: '#e0e0e0' }
                        }
                    }
                }
            });
        }

        // Check URL params for agent selection
        const urlParams = new URLSearchParams(window.location.search);
        const agentParam = urlParams.get('agent');
        if (agentParam) {
            document.getElementById('agent-select').value = agentParam;
        }

        // Load initial data
        loadDriftData();
    </script>
</body>
</html>
