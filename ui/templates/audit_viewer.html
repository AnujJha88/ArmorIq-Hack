<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TIRS - Audit Log</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <span class="logo">üõ°Ô∏è</span>
            <span class="brand-text">TIRS Dashboard</span>
        </div>
        <div class="nav-links">
            <a href="/" class="nav-link">Dashboard</a>
            <a href="/drift" class="nav-link">Drift Graph</a>
            <a href="/audit" class="nav-link active">Audit Log</a>
        </div>
        <div class="nav-status">
            <span class="status-indicator online"></span>
            <span>System Online</span>
        </div>
    </nav>

    <main class="audit-page">
        <header class="page-header">
            <h1>Audit Log</h1>
            <p>Complete event history with cryptographic verification</p>
        </header>

        <div class="controls">
            <input type="text" id="search-input" placeholder="Search events..." onkeyup="filterEvents()">
            
            <select id="event-filter" onchange="filterEvents()">
                <option value="">All Events</option>
                <option value="INTENT_CAPTURED">Intent Captured</option>
                <option value="PLAN_SIMULATED">Plan Simulated</option>
                <option value="POLICY_ALLOW">Policy Allow</option>
                <option value="POLICY_DENY">Policy Deny</option>
                <option value="DRIFT_WARNING">Drift Warning</option>
                <option value="AGENT_PAUSED">Agent Paused</option>
                <option value="AGENT_KILLED">Agent Killed</option>
            </select>

            <button class="btn" onclick="exportJSON()">üì• Export JSON</button>
            <button class="btn" onclick="exportCSV()">üì• Export CSV</button>
        </div>

        <div class="audit-table-container">
            <table class="audit-table" id="audit-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Time</th>
                        <th>Agent</th>
                        <th>Event Type</th>
                        <th>Details</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in events %}
                    <tr class="event-row" data-event="{{ event.event }}" data-agent="{{ event.agent }}">
                        <td><code>#{{ event.id }}</code></td>
                        <td>{{ event.time }}</td>
                        <td><code>{{ event.agent }}</code></td>
                        <td>
                            <span class="event-badge {{ event.event|lower|replace('_', '-') }}">
                                {{ event.event }}
                            </span>
                        </td>
                        <td>{{ event.details }}</td>
                        <td>
                            <button class="btn btn-small" onclick="viewDetails({{ event.id }})">View</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button class="btn btn-small" disabled>‚Üê Previous</button>
            <span class="page-info">Page 1 of 1</span>
            <button class="btn btn-small" disabled>Next ‚Üí</button>
        </div>
    </main>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Event Details</h3>
                <button class="btn-close" onclick="closeModal()">√ó</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Details loaded dynamically -->
            </div>
        </div>
    </div>

    <script>
        function filterEvents() {
            const search = document.getElementById('search-input').value.toLowerCase();
            const eventFilter = document.getElementById('event-filter').value;
            const rows = document.querySelectorAll('.event-row');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const eventType = row.dataset.event;
                
                const matchesSearch = text.includes(search);
                const matchesFilter = !eventFilter || eventType === eventFilter;
                
                row.style.display = (matchesSearch && matchesFilter) ? '' : 'none';
            });
        }

        function viewDetails(eventId) {
            document.getElementById('modal-body').innerHTML = `
                <p><strong>Event ID:</strong> ${eventId}</p>
                <p><strong>Signature:</strong> <code>sha256:abc123...</code></p>
                <p><strong>Verified:</strong> ‚úÖ Valid</p>
                <pre>{ "event_id": ${eventId}, "verified": true }</pre>
            `;
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        async function exportJSON() {
            const response = await fetch('/api/audit');
            const data = await response.json();
            
            const blob = new Blob([JSON.stringify(data.events, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tirs_audit_log.json';
            a.click();
        }

        function exportCSV() {
            const rows = document.querySelectorAll('.event-row:not([style*="none"])');
            let csv = 'ID,Time,Agent,Event,Details\n';
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [
                    cells[0].textContent.trim(),
                    cells[1].textContent.trim(),
                    cells[2].textContent.trim(),
                    cells[3].textContent.trim(),
                    `"${cells[4].textContent.trim()}"`
                ];
                csv += rowData.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'tirs_audit_log.csv';
            a.click();
        }

        // Close modal on escape key
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') closeModal();
        });
    </script>
</body>
</html>
